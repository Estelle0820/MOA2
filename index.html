<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MOA2 Test (3 Trials)</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
</head>
<body></body>

<!-- CSV parser -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script type="module">
  import { initJsPsych } from "https://esm.sh/jspsych";
  import jsPsychHtmlButtonResponse from "https://esm.sh/@jspsych/plugin-html-button-response";
  import jsPsychHtmlSliderResponse from "https://esm.sh/@jspsych/plugin-html-slider-response";

  // ---- Google Sheet logging ----
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbzvtPMbYspu9ViCg7v_5PftC27yxh4LU6b7s6BEIUPJ5i-i2ii9-ccrjAL7ViLvmGJUkg/exec";

  const jsPsych = initJsPsych({
    on_finish: () => {
      const data = jsPsych.data.get().values();
      data.forEach(row => {
        fetch(SHEET_URL, {
          method: "POST",
          body: JSON.stringify(row),
          headers: { "Content-Type": "application/json" }
        }).catch(err => console.error("Error sending to sheet:", err));
      });
      // also show preview table
      jsPsych.data.displayData();
    }
  });

  // --- helper (simplified) ---
  function videoTrial(stimulus, meta){
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div style="text-align:center">
          <p><em>Watch carefully. Continue appears after the clip ends.</em></p>
          <video id="trial-video" width="700" controls preload="metadata">
            <source src="${stimulus}" type="video/mp4">
          </video>
        </div>`,
      choices: ["Continue"],
      data: { phase:"video", stimulus, ...meta },
      on_load: () => {
        const btn = document.querySelector(".jspsych-btn");
        const v = document.getElementById("trial-video");
        if (btn) btn.style.display = "none";
        v.addEventListener("ended", ()=>{ btn.style.display=""; }, {once:true});
      }
    };
  }

  function prefSlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<p><strong>How much did you like the clip?</strong></p>',
      min:0, max:4, step:1, slider_start:2,
      labels: ['0 (Not at all)','1','2 (Neutral)','3','4 (Very much)'],
      require_movement:true,
      data: { phase:"preference", ...t }
    };
  }

  function simultaneitySlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<p><strong>To what extent did the visual and auditory motion begin at the same time?</strong></p>',
      min:0, max:4, step:1, slider_start:2,
      labels: ['0 (Very far apart)','1','2 (Somewhat apart)','3','4 (Exactly the same time)'],
      require_movement:true,
      data: { phase:"simultaneity", ...t }
    };
  }

  // --- Build timeline ---
  const timeline = [];

  // Practice
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h2>Practice</h2><p>You will watch one practice clip and answer 2 rating questions.</p>',
    choices: ["Begin Practice"]
  });
  timeline.push( videoTrial("videos/practice_v1.mp4", {practice:true}) );
  timeline.push( prefSlider({practice:true}) );
  timeline.push( simultaneitySlider({practice:true}) );

  // Only 3 trials (for testing)
  const demoVideos = [
    {scene:"dog", stimulus:"videos/dog_v1_LtoR_sync.mp4"},
    {scene:"penguin", stimulus:"videos/penguin_v1_LtoR_3s.mp4"},
    {scene:"car", stimulus:"videos/car_v1_RtoL_7s.mp4"}
  ];

  demoVideos.forEach(t=>{
    timeline.push( videoTrial(t.stimulus, t) );
    timeline.push( prefSlider(t) );
    timeline.push( simultaneitySlider(t) );
  });

  // End
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<p>Thanks! That is the end of the test run.</p>',
    choices: ['Finish']
  });

  // Run
  jsPsych.run(timeline);

</script>
</html>

